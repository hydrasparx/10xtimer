<html>
<head>
<style>
#container { height: 100%; }
#counter { max-width: 640px; border: 1px solid black; margin: auto auto }
#counter #main { font-size: 30px; }
#counter #ms { font-size: 15px; }
</style>
</head>
<body>
<script>
var freq1 = 440;
var freq2 = 660;
var duration = 0.15
var audioCtx;
var timer;

function d2(val) {
	return ('0' + parseInt(val)).slice(-2);
}

function play() {
	audioCtx = new (window.AudioContext || window.webkitAudioContext)();
	let counter = 0;
	timer = setInterval(() => {
		//counter += 0.1; 
		counter = audioCtx.currentTime;
		let m = d2(counter / 60);
		let s = d2(counter % 60);
		let ms = parseInt((counter % 1) * 10);
		document.getElementById('main').innerText = `${m}:${s}`;
		document.getElementById('ms').innerText = `.${ms}`;
	},100);

	let offset = audioCtx.currentTime + 1;
	for (let i = 0; i < 60; i++) { 
		let beat = (i % 5);
		start = offset + i;
		
		let oscillator = audioCtx.createOscillator();
		let envelope = audioCtx.createGain();

		oscillator.frequency.value = freq1; 
		if (beat >= 3) {
			oscillator.frequency.value = freq2;
		}
		
		envelope.gain.value = 0.5;
		envelope.gain.exponentialRampToValueAtTime(1, start + 0.001);
		envelope.gain.exponentialRampToValueAtTime(0.3, start + (duration * 0.8));
		
		//oscillator.connect(audioCtx.destination);
		oscillator.connect(envelope);
		envelope.connect(audioCtx.destination);
		oscillator.start(start); 
		oscillator.stop(start + duration);

/*
		oscillator.onended = function() {
		console.log('ended');
		}
*/
	}
}

function pause() {
	audioCtx.suspend();
}

function resume() {
	audioCtx.resume();
}

function toggle() {
	let btnToggle = document.getElementById('btnToggle');
	let state = btnToggle.innerText;
	console.log(state);
	if (state == 'Play') {
		btnToggle.innerText = 'Pause';
		play();
	} else if (state == 'Pause') {
		btnToggle.innerText = 'Resume';
		pause();
	} else if (state == 'Resume') {
		btnToggle.innerText = 'Pause';
		resume();
	}
	
}

function stop() {
	audioCtx.close();
	clearInterval(timer);
}

function reset() {
	stop();
	document.getElementById('btnToggle').innerText = 'Play';
	document.getElementById('main').innerText = '00:00';
	document.getElementById('ms').innerText = '.0';
}



</script>
<div id="container">
	<div id="counter"><span id="main">00:00</span><span id="ms">.0</span></div>
	<button id="btnToggle" onclick="toggle()">Play</button>
	<button onclick="reset()">Reset</button>
</div>
</body>
</html>
